<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthConnect - AI-Powered SDoH Screening</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .reward-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .reward-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(93, 92, 222, 0.15);
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#F8F9FA',
                        accent: '#E8F2FF'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
</head>
<body class="bg-secondary dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                        <i data-feather="heart" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="font-bold text-lg">HealthConnect</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="pointsDisplay" class="flex items-center space-x-1 bg-amber-100 dark:bg-amber-900 px-3 py-1 rounded-full">
                        <i data-feather="star" class="w-4 h-4 text-amber-600"></i>
                        <span class="text-sm font-medium text-amber-700 dark:text-amber-300">125 pts</span>
                    </div>
                    <button id="menuBtn" class="p-2">
                        <i data-feather="menu" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-md mx-auto">
        <!-- Landing Page -->
        <div id="landingPage" class="p-6">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-br from-primary to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i data-feather="heart" class="w-12 h-12 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold mb-2">Welcome to HealthConnect</h1>
                <p class="text-gray-600 dark:text-gray-400">Pre-appointment AI health screening with personalized insights</p>
            </div>

            <div class="space-y-4 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i data-feather="message-circle" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold">Pre-Appointment Screening</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Answer a few questions to prepare for your visit.</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                        <i data-feather="map-pin" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold">Local Health Insights</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Get personalized alerts based on your location.</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 flex items-center space-x-3">
                    <div class="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center">
                        <i data-feather="gift" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold">Earn Rewards</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Get points for engaging with your health.</p>
                    </div>
                </div>
            </div>

            <button id="startBtn" class="w-full bg-primary text-white py-4 rounded-lg font-semibold text-lg hover:bg-purple-600 transition-colors">
                Begin Pre-Appointment Check-in
            </button>

            <p class="text-xs text-gray-500 text-center mt-4">
                Your privacy is protected. All data is encrypted and HIPAA compliant.
            </p>
        </div>

        <!-- Onboarding -->
        <div id="onboardingPage" class="hidden p-6">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Getting Started</h2>
                    <span class="text-sm text-gray-500">Step 1 of 3</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-primary h-2 rounded-full progress-bar" style="width: 33%"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label for="firstName" class="block text-sm font-medium mb-2">Full Name</label>
                    <input type="text" id="firstName" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800" placeholder="Enter your first name">
                </div>

                <div>
                    <label for="zipCode" class="block text-sm font-medium mb-2">ZIP Code</label>
                    <input type="text" id="zipCode" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800" placeholder="e.g., 10001 for NYC">
                    <p class="text-xs text-gray-500 mt-1">We use this to find local resources and health insights for you.</p>
                </div>

                <div>
                    <label for="language" class="block text-sm font-medium mb-2">Preferred Language</label>
                    <select id="language" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800">
                        <option>English</option>
                        <option>Spanish</option>
                        <option>French</option>
                        <option>Chinese</option>
                    </select>
                </div>

                <div class="bg-blue-50 dark:bg-gray-800 p-4 rounded-lg">
                    <div class="flex items-start space-x-3">
                        <i data-feather="shield" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                        <div class="text-sm">
                            <p class="font-medium text-blue-800 dark:text-blue-200">Privacy Notice</p>
                            <p class="text-blue-700 dark:text-blue-300 mt-1">Your responses are confidential and used only to provide personalized health insights and local resources.</p>
                        </div>
                    </div>
                </div>

                <button id="continueOnboarding" class="w-full bg-primary text-white py-3 rounded-lg font-semibold">
                    Continue
                </button>
            </div>
        </div>

        <!-- Consent Page -->
        <div id="consentPage" class="hidden p-6">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Privacy & Consent</h2>
                    <span class="text-sm text-gray-500">Step 2 of 3</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-primary h-2 rounded-full progress-bar" style="width: 66%"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-semibold mb-3">Data Collection & Use</h3>
                    <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        <li class="flex items-start space-x-2">
                            <i data-feather="check" class="w-4 h-4 text-green-500 mt-0.5"></i>
                            <span>HIPAA compliant data handling</span>
                        </li>
                        <li class="flex items-start space-x-2">
                            <i data-feather="check" class="w-4 h-4 text-green-500 mt-0.5"></i>
                            <span>Anonymized screening responses</span>
                        </li>
                        <li class="flex items-start space-x-2">
                            <i data-feather="check" class="w-4 h-4 text-green-500 mt-0.5"></i>
                            <span>Encrypted data transmission</span>
                        </li>
                        <li class="flex items-start space-x-2">
                            <i data-feather="check" class="w-4 h-4 text-green-500 mt-0.5"></i>
                            <span>No data sharing without consent</span>
                        </li>
                    </ul>
                </div>

                <div class="space-y-4">
                    <label class="flex items-start space-x-3">
                        <input type="checkbox" id="dataConsent" class="mt-1 form-checkbox rounded text-primary focus:ring-primary">
                        <span class="text-sm">I consent to the collection and use of my health screening data to provide personalized insights and local resource recommendations.</span>
                    </label>

                    <label class="flex items-start space-x-3">
                        <input type="checkbox" id="rewardsConsent" class="mt-1 form-checkbox rounded text-primary focus:ring-primary">
                        <span class="text-sm">I agree to participate in the rewards program and receive community challenges and incentives.</span>
                    </label>

                    <label class="flex items-start space-x-3">
                        <input type="checkbox" id="communicationConsent" class="mt-1 form-checkbox rounded text-primary focus:ring-primary">
                        <span class="text-sm">I consent to receive health-related communications and local resource updates via the app.</span>
                    </label>
                </div>

                <button id="acceptConsent" class="w-full bg-primary text-white py-3 rounded-lg font-semibold disabled:bg-gray-400 dark:disabled:bg-gray-600" disabled>
                    Accept & Continue
                </button>
            </div>
        </div>

        <!-- Welcome Dashboard -->
        <div id="welcomePage" class="hidden p-6">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Welcome Setup</h2>
                    <span class="text-sm text-gray-500">Step 3 of 3</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-primary h-2 rounded-full progress-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-green-100 dark:bg-green-800 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i data-feather="check" class="w-8 h-8 text-green-600"></i>
                </div>
                <h3 class="text-lg font-semibold mb-2">You're all set, <span id="welcomeName"></span>!</h3>
                <p class="text-gray-600 dark:text-gray-400">Let's start with your health screening</p>
            </div>

            <div class="bg-gradient-to-r from-primary to-purple-600 rounded-lg p-6 text-white mb-6">
                <h4 class="font-semibold mb-2">üè• Pre-Appointment Preparation</h4>
                <p class="text-sm mb-3">Complete your health screening to optimize your upcoming appointment and earn 50 points!</p>
                <div class="bg-white bg-opacity-20 rounded-full h-2 mb-2">
                    <div class="bg-white h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs opacity-90">0/50 points earned</p>
            </div>

            <button id="startScreening" class="w-full bg-primary text-white py-3 rounded-lg font-semibold">
                Start Pre-Appointment Screening
            </button>
        </div>

        <!-- Chatbot Interface -->
        <div id="chatPage" class="hidden flex flex-col h-screen-minus-nav">
             <div class="bg-white dark:bg-gray-800 p-4 border-b dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button id="backBtn">
                            <i data-feather="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <div>
                            <h2 class="font-semibold">AI Health Assistant</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Pre-appointment check-in</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
                        <span class="text-xs">Online</span>
                    </div>
                </div>
            </div>

            <div id="chatMessages" class="flex-1 p-4 space-y-4 overflow-y-auto">
                <!-- Messages will be added here -->
            </div>

            <div class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 p-4">
                <div class="max-w-md mx-auto">
                    <div id="quickResponses" class="hidden mb-3 flex flex-wrap gap-2 justify-center">
                        <!-- Quick response buttons will be added here -->
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="chatInput" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800" placeholder="Type your response..." disabled>
                        <button id="sendBtn" class="bg-primary text-white p-3 rounded-lg disabled:bg-gray-400" disabled>
                            <i data-feather="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboardPage" class="hidden p-6 pb-20">
            <div class="mb-6">
                <h2 class="text-xl font-bold mb-2">Health Summary</h2>
                <p class="text-gray-600 dark:text-gray-400">Personalized insights for ZIP code: <span id="userZip" class="font-medium text-primary"></span></p>
            </div>
            
            <!-- Location Health Risks -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-6 border border-gray-200 dark:border-gray-700">
                <h3 class="font-semibold mb-4 flex items-center">
                    <i data-feather="map-pin" class="w-5 h-5 mr-2 text-primary"></i>
                    Local Environmental Factors
                </h3>
                <div id="healthRiskSummary" class="space-y-4">
                    <!-- Summary will be populated here by JS -->
                    <p class="text-sm text-gray-500">Complete the AI health screening to see personalized insights for your area.</p>
                </div>
            </div>

            <!-- Points & Rewards -->
            <div class="bg-gradient-to-r from-amber-400 to-orange-500 rounded-lg p-4 mb-6 text-white">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold">Rewards Progress</h3>
                    <i data-feather="gift" class="w-5 h-5"></i>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span id="dashboardPoints" class="text-sm">125 / 200 points</span>
                    <span class="text-sm">Next reward: $10 grocery voucher</span>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full h-2">
                    <div id="dashboardPointsBar" class="bg-white h-2 rounded-full" style="width: 62.5%"></div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="resourcesBtn" class="bg-blue-50 dark:bg-gray-800 p-4 rounded-lg text-center">
                    <i data-feather="globe" class="w-6 h-6 text-blue-600 mx-auto mb-2"></i>
                    <span class="text-sm font-medium">Local Resources</span>
                </button>
                <button id="rewardsBtn" class="bg-green-50 dark:bg-gray-800 p-4 rounded-lg text-center">
                    <i data-feather="award" class="w-6 h-6 text-green-600 mx-auto mb-2"></i>
                    <span class="text-sm font-medium">View Rewards</span>
                </button>
            </div>
        </div>

        <!-- Local Resources Page (Stub) -->
        <div id="resourcesPage" class="hidden p-6 pb-20">
             <h2 class="text-xl font-bold mb-4">Local Resources</h2>
             <p>Resource list will be displayed here.</p>
        </div>

        <!-- Rewards Page (Stub) -->
        <div id="rewardsPage" class="hidden p-6 pb-20">
             <h2 class="text-xl font-bold mb-4">Rewards</h2>
             <p>Rewards store will be displayed here.</p>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
        <div class="max-w-md mx-auto px-4 py-2">
            <div class="flex justify-around">
                <button class="nav-btn flex flex-col items-center py-2 px-3 text-gray-600 dark:text-gray-400" data-page="dashboard">
                    <i data-feather="home" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Home</span>
                </button>
                <button class="nav-btn flex flex-col items-center py-2 px-3 text-gray-600 dark:text-gray-400" data-page="chat">
                    <i data-feather="message-circle" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Chat</span>
                </button>
                <button class="nav-btn flex flex-col items-center py-2 px-3 text-gray-600 dark:text-gray-400" data-page="resources">
                    <i data-feather="map-pin" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Resources</span>
                </button>
                <button class="nav-btn flex flex-col items-center py-2 px-3 text-gray-600 dark:text-gray-400" data-page="rewards">
                    <i data-feather="gift" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Rewards</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Dark mode, Feather Icons, etc. ---
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) { document.documentElement.classList.add('dark'); } 
            else { document.documentElement.classList.remove('dark'); }
        });
        

        // --- App State ---
        let currentPage = 'landing';
        let userData = {
            firstName: '',
            zipCode: ''
        };
        let chatHistory = [];
        let points = 125;
        let currentQuestionIndex = 0;

        // --- Mock Data ---
        // FIXED: Restored the screening questions
        const screeningQuestions = [
            {
                id: 'intro',
                text: "Hello! I'm your AI Health Screening Assistant. To start, how are you feeling today overall?",
                type: 'choice',
                options: ['Excellent', 'Good', 'Fair', 'Poor'],
                points: 10
            },
            {
                id: 'symptoms',
                text: "Thank you. Have you experienced any new or worsening symptoms since your last visit?",
                type: 'choice',
                options: ['No new symptoms', 'Mild symptoms', 'Moderate symptoms', 'Severe symptoms'],
                points: 15
            },
            {
                id: 'medications',
                text: "Are you currently taking all prescribed medications as directed?",
                type: 'choice',
                options: ['Taking as prescribed', 'Minor missed doses', 'Frequent missed doses', 'Stopped taking them'],
                points: 15
            },
            {
                id: 'housing',
                text: "Thinking about things that can affect health, how stable is your current housing situation?",
                type: 'choice',
                options: ['Very stable', 'Somewhat stable', 'Unstable', 'No stable housing'],
                points: 10
            },
            {
                id: 'food',
                text: "In the past 12 months, did you worry your food would run out before you got money to buy more?",
                type: 'choice',
                options: ['Never', 'Sometimes', 'Often', 'Very often'],
                points: 15
            },
            {
                id: 'transportation',
                text: "How reliable is your transportation for getting to medical appointments?",
                type: 'choice',
                options: ['Always reliable', 'Usually reliable', 'Sometimes unreliable', 'Major barriers'],
                points: 15
            },
        ];

        const zipCodeHealthRisks = {
            '100': { 
                areaName: "New York City Area",
                risks: [
                    {
                        title: "High Pollen Count",
                        risk: "Increased",
                        details: "Spring and fall may bring high pollen counts, increasing allergy and asthma symptoms. Monitor local pollen forecasts."
                    },
                    {
                        title: "Air Pollution",
                        risk: "Moderate",
                        details: "Urban environments can have higher air pollution. On poor air quality days, consider limiting strenuous outdoor activities."
                    }
                ]
            },
            '902': { 
                areaName: "Los Angeles County",
                risks: [
                    {
                        title: "High Sun Exposure",
                        risk: "High",
                        details: "This area has significant sun exposure. Use sunscreen and protective clothing to reduce skin damage risk."
                    },
                    {
                        title: "Wildfire Smoke",
                        risk: "Seasonal",
                        details: "During wildfire season, air quality can be impacted. Stay indoors and use air purifiers when smoke is heavy."
                    }
                ]
            },
            'default': {
                areaName: "your area",
                risks: [
                    {
                        title: "General Wellness",
                        risk: "Standard",
                        details: "Remember to stay hydrated, get regular exercise, and maintain a balanced diet for optimal health."
                    }
                ]
            }
        };

        // --- Navigation & Page Management ---
        function showPage(pageId) {
            document.querySelectorAll('[id$="Page"]').forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(pageId + 'Page');
            if(targetPage) {
                targetPage.classList.remove('hidden');
            }

            // FIXED: Correctly show/hide bottom nav. It's hidden for landing, onboarding, consent, welcome, and chat.
            const showBottomNav = ['dashboard', 'resources', 'rewards'].includes(pageId);
            document.getElementById('bottomNav').classList.toggle('hidden', !showBottomNav);

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary');
                btn.classList.add('text-gray-600', 'dark:text-gray-400');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                activeBtn.classList.add('text-primary');
            }

            currentPage = pageId;

            if (pageId === 'dashboard') {
                updateDashboard();
            }
            feather.replace(); // Refresh icons on page change
        }
        
        function updateDashboard() {
            document.getElementById('userZip').textContent = userData.zipCode || 'N/A';
            updatePointsDisplay();
            const summaryData = getLocationData(userData.zipCode);
            updateDashboardSummary(summaryData);
        }

        // --- Chat Functions ---
        function addMessage(text, isBot = true, hasOptions = false, options = []) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble flex w-full ${isBot ? 'justify-start' : 'justify-end'}`;

            const bubbleClass = isBot 
                ? 'bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white rounded-r-lg rounded-bl-lg' 
                : 'bg-primary text-white rounded-l-lg rounded-br-lg';
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-3 ${bubbleClass}">
                    ${isBot ? '<div class="flex items-center space-x-2 mb-2"><div class="w-6 h-6 bg-primary rounded-full flex items-center justify-center shrink-0"><i data-feather="cpu" class="w-4 h-4 text-white"></i></div><span class="text-xs font-medium opacity-80">AI Assistant</span></div>' : ''}
                    <p class="text-sm">${text}</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            feather.replace();

            if (hasOptions && options.length > 0) {
                setTimeout(() => showQuickResponses(options), 500);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showQuickResponses(options) {
            const quickResponses = document.getElementById('quickResponses');
            quickResponses.innerHTML = '';
            quickResponses.classList.remove('hidden');
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'bg-accent dark:bg-gray-700 hover:bg-blue-200 dark:hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-medium transition-colors';
                button.textContent = option;
                button.onclick = () => selectQuickResponse(option);
                quickResponses.appendChild(button);
            });
        }

        function selectQuickResponse(response) {
            addMessage(response, false);
            document.getElementById('quickResponses').classList.add('hidden');

            const currentQuestion = screeningQuestions[currentQuestionIndex];
            if (currentQuestion) {
                points += currentQuestion.points;
                updatePointsDisplay();
                showPointsEarned(currentQuestion.points);
            }
            currentQuestionIndex++;

            setTimeout(() => {
                if (currentQuestionIndex < screeningQuestions.length) {
                    const nextQuestion = screeningQuestions[currentQuestionIndex];
                    addMessage(nextQuestion.text, true, true, nextQuestion.options);
                } else {
                    completeScreening();
                }
            }, 1000);
        }

        function completeScreening() {
            const totalPoints = screeningQuestions.reduce((sum, q) => sum + q.points, 0);
            addMessage(`Excellent! You've completed your health screening. You've earned ${totalPoints} points! üåü`, true);
            
            setTimeout(() => {
                addMessage("I'm now generating a personalized summary based on your location...", true);
                
                setTimeout(() => {
                    const summary = generateLocationBasedSummary(userData.zipCode);
                    addMessage(summary, true);

                    setTimeout(() => {
                        const dashboardButton = document.createElement('div');
                        dashboardButton.className = 'flex justify-center mt-4';
                        dashboardButton.innerHTML = `
                            <button onclick="showPage('dashboard')" class="bg-primary text-white px-6 py-2 rounded-lg font-medium shadow-lg hover:shadow-xl transition-shadow">
                                View Full Health Summary
                            </button>
                        `;
                        document.getElementById('chatMessages').appendChild(dashboardButton);
                        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                    }, 1000);

                }, 1500);
            }, 1000);
        }

        function getLocationData(zipCode) {
            let key = 'default';
            if (zipCode) {
                if (zipCode.startsWith('100')) key = '100';
                else if (zipCode.startsWith('902')) key = '902';
            }
            return zipCodeHealthRisks[key];
        }

        function generateLocationBasedSummary(zipCode) {
            const data = getLocationData(zipCode);
            let summaryText = `Based on your location in the <strong>${data.areaName}</strong>, here are some environmental factors to be aware of:<br><br><ul class="list-disc list-inside space-y-2">`;
            data.risks.forEach(risk => {
                summaryText += `<li><strong>${risk.title}:</strong> ${risk.details}</li>`;
            });
            summaryText += "</ul><br>Please discuss any concerns with your healthcare provider.";
            return summaryText;
        }
        
        function updateDashboardSummary(data) {
            const summaryContainer = document.getElementById('healthRiskSummary');
            summaryContainer.innerHTML = ''; 

            data.risks.forEach(risk => {
                const riskLevelMap = {
                    'Increased': { color: 'yellow', width: '60%' },
                    'Moderate': { color: 'yellow', width: '60%' },
                    'High': { color: 'red', width: '85%' },
                    'Seasonal': { color: 'blue', width: '50%' },
                    'Standard': { color: 'green', width: '25%' },
                };
                const level = riskLevelMap[risk.risk] || riskLevelMap['Standard'];

                const riskElement = document.createElement('div');
                riskElement.className = 'border-l-4 rounded-r-md p-3';
                riskElement.classList.add(`border-${level.color}-500`, `bg-${level.color}-50`, `dark:bg-gray-800`);

                riskElement.innerHTML = `
                     <div class="flex justify-between items-center mb-1">
                        <h4 class="font-semibold text-sm text-gray-800 dark:text-white">${risk.title}</h4>
                        <span class="text-xs font-medium text-${level.color}-600 dark:text-${level.color}-400 ml-3">${risk.risk}</span>
                     </div>
                     <p class="text-xs text-gray-600 dark:text-gray-400">${risk.details}</p>
                `;
                summaryContainer.appendChild(riskElement);
            });
        }


        // --- Points & UI Updates ---
        function showPointsEarned(earnedPoints) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg z-50 shadow-lg';
            notification.style.animation = 'fadeInOut 2s ease-in-out';
            notification.innerHTML = `+${earnedPoints} points! üåü`;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 2000);
        }

        function updatePointsDisplay() {
            document.getElementById('pointsDisplay').innerHTML = `
                <i data-feather="star" class="w-4 h-4 text-amber-600"></i>
                <span class="text-sm font-medium text-amber-700 dark:text-amber-300">${points} pts</span>
            `;
            feather.replace();
            
            const dashboardPoints = document.getElementById('dashboardPoints');
            if(dashboardPoints) {
                dashboardPoints.textContent = `${points} / 200 points`;
                const pointsBar = document.getElementById('dashboardPointsBar');
                pointsBar.style.width = `${Math.min(100, (points / 200) * 100)}%`;
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startBtn').addEventListener('click', () => showPage('onboarding'));

            document.getElementById('continueOnboarding').addEventListener('click', () => {
                const firstName = document.getElementById('firstName').value.trim();
                const zipCode = document.getElementById('zipCode').value.trim();
                
                if (!firstName || !zipCode) {
                    alert("Please fill out all fields.");
                    return;
                }

                userData.firstName = firstName;
                userData.zipCode = zipCode;
                document.getElementById('welcomeName').textContent = userData.firstName;
                showPage('consent');
            });

            const consentCheckboxes = ['dataConsent', 'rewardsConsent', 'communicationConsent'];
            consentCheckboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    const allChecked = consentCheckboxes.every(checkboxId => document.getElementById(checkboxId).checked);
                    document.getElementById('acceptConsent').disabled = !allChecked;
                });
            });

            document.getElementById('acceptConsent').addEventListener('click', () => showPage('welcome'));

            document.getElementById('startScreening').addEventListener('click', () => {
                showPage('chat');
                currentQuestionIndex = 0; 
                document.getElementById('chatMessages').innerHTML = ''; 
                setTimeout(() => addMessage(screeningQuestions[0].text, true, true, screeningQuestions[0].options), 500);
            });

            document.getElementById('backBtn').addEventListener('click', () => showPage('dashboard'));
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    if(page === 'chat') {
                        // Special handling to restart chat if accessed from nav
                        showPage('chat');
                        currentQuestionIndex = 0; 
                        document.getElementById('chatMessages').innerHTML = '';
                        setTimeout(() => addMessage(screeningQuestions[0].text, true, true, screeningQuestions[0].options), 500);
                    } else {
                        showPage(page);
                    }
                });
            });

            document.getElementById('resourcesBtn').addEventListener('click', () => showPage('resources'));
            document.getElementById('rewardsBtn').addEventListener('click', () => showPage('rewards'));

            // --- Initialize App ---
            showPage('landing');
            feather.replace();
        });
    </script>
     <style>
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            20% { opacity: 1; transform: translate(-50%, 0); }
            80% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        .h-screen-minus-nav {
             height: calc(100vh - 61px); /* Adjust 61px to match your nav height */
        }
    </style>
</body>
</html>